---
title: "Gynecologic Oncology Accessibility Project"
author: "Tyler Muffly, MD"
date: "2025-02-09"
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Project Overview

This project analyzes nationwide access to gynecologic oncologists and other OBGYN subspecialists using drive time isochrones, demographic data, and geospatial analysis. The analysis examines how accessibility varies across different geographic areas, demographic groups, and time periods (2013-2023).

Using the HERE Maps API and census data, we calculate drive time isochrones around gynecologic oncologists' locations and analyze the demographics of populations within each drive time threshold. The project examines changes in accessibility over time and retirement patterns among specialists.

### Subspecialists Analyzed
- Female Pelvic Medicine and Reconstructive Surgery/Urogynecology
- Gynecologic Oncology
- Maternal-Fetal Medicine
- Reproductive Endocrinology and Infertility

## File Organization

### Core Analysis Workflow

#### Data Gathering
- `Gathering data.R` - Auxiliary script for data compilation
- `Postico_database_pull.R` - Retrieves physician data from PostgreSQL
- `getting_isochrones_trying.R` - Alternative method for isochrone generation
- `retirement.R` - Basic retirement analysis
- `retirement_adjusted.R` - Improved retirement analysis with multiple data sources
- `script.R` - Reference script demonstrating the workflow
- `subspecialists over time.R` - Analysis of subspecialist trends
- `visualize_fips_inters_isochr.R` - Visualizes FIPS code intersections
- `fips_blocks_female_proportion.R` - Analyzes female population in FIPS blocks
- `fips_isochrones_population_intersect.R` - Examines population within isochrones

#### 1. Setup and Data Preparation
- `01-setup.R` - Loads packages, sets API keys, defines helper functions, initializes directory structure
- `02-search_taxonomy.R` - Retrieves gynecologic oncology subspecialists from NPI database
- `02.5-subspecialists_over_time.R` - Analyzes subspecialist trends over multiple years
- `03-search_and_process_npi.R` - Processes National Provider Identifier (NPI) data
- `03a-search_and_process_extra.R` - Additional NPI processing for edge cases
- `04-geocode.R` - Geocodes provider addresses using the HERE API
- `05-geocode-cleaning.R` - Cleans and standardizes geocoded data

#### 2. Isochrone Generation and Analysis
- `06-isochrones.R` - Generates drive time isochrones (30, 60, 120, 180 min)
- `07-isochrone-mapping.R` - Maps isochrones and performs spatial joins
- `07.5-prep-get-block-group-overlap.R` - Prepares census block group data
- `08-get-block-group-overlap.R` - Calculates overlap between isochrones and census blocks
- `08.5-prep-the-census-variables.R` - Prepares demographic variables from Census
- `09-get-census-population.R` - Calculates population within/outside isochrones

#### 3. Results and Analysis
- `10-calculate-polygon-demographcs.R` - Analyzes demographic characteristics
- `10-make-region.R` - Creates regional maps and analyses
- `analyze_isochrone_data.R` - Framework for analyzing isochrone data
- `calculate_population_in_isochrones_by_race.R` - Analyzes population by race within isochrones
- `walker_isochrone_maps.R` - Visualizes isochrone changes over time

### R Markdown Documents
- `GO_access_analysis_code.Rmd` - Statistical analysis of gynecologic oncology access
- `for_every_year_script_rmd.Rmd` - Year-by-year analysis of accessibility trends
- `isochrones.Rmd` - Tutorial on creating and analyzing isochrones

## Execution Order

For a complete analysis, the files should be executed in approximately this order:

### Setup Phase
1. `01-setup.R`
2. `Postico_database_pull.R` (if external hardrive with the Positico database access is connected)

### Data Collection Phase
3. `02-search_taxonomy.R`
4. `02.5-subspecialists_over_time.R`
5. `03-search_and_process_npi.R`
6. `03a-search_and_process_extra.R`
7. `04-geocode.R`
8. `05-geocode-cleaning.R`

### Isochrone Analysis Phase
9. `06-isochrones.R`
10. `07-isochrone-mapping.R`
11. `07.5-prep-get-block-group-overlap.R`
12. `08-get-block-group-overlap.R`
13. `08.5-prep-the-census-variables.R`
14. `09-get-census-population.R`

### Results and Additional Analysis Phase
15. `10-calculate-polygon-demographcs.R`
16. `10-make-region.R`
17. `retirement.R`/`retirement_adjusted.R` (if physician retirement analysis is needed)
18. `walker_isochrone_maps.R`
19. `analyze_isochrone_data.R`
20. `calculate_population_in_isochrones_by_race.R`
21. `for_every_year_script_rmd.Rmd`
22. `GO_access_analysis_code.Rmd`

## Methods

### Data Sources
- Physician Data: National Plan and Provider Enumeration System (NPPES) files from 2013 to 2023
- Population Data: American Community Survey 5-year estimates and decennial census data
- Geographic Analysis: Used block groups rather than counties for finer data resolution
- Geographic Regions: American College of Obstetricians and Gynecologists (ACOG) Districts

### Analysis Approach
- Drive time isochrones (30, 60, 120, 180 minutes) calculated using HERE API
- Isochrones generated for the third Friday in October at 9:00 AM for each year
- Demographic analysis by race/ethnicity (White, Black, Asian or Pacific Islander, American Indian/Alaska Native)
- Comparison of urban vs. rural accessibility

## Prerequisites

- R 4.0.0 or higher
- Required R packages (listed in `01-setup.R`)
- HERE Maps API key
- Census API key
- PostgreSQL database (optional, for historical physician data)

## Tools and Data Management

### HERE API
- Used for geocoding and isochrone generation
- Geocoding and Search: $0.83 per 1,000 searches after 30,000 free geocodes
- Isoline Routing: $5.50 per 1,000 after 2,500 free isoline routings

### Data Storage
- GitHub LFS (Large File Storage) for managing large files
- DuckDB for efficient data querying
- PostgreSQL database for year-specific physician data

### Auxiliary Tools
- tyler package: Custom package for project-specific functions
- Exploratory.io: Used for data wrangling

## Key Outputs
- Drive time isochrones at multiple thresholds (30, 60, 120, 180 minutes)
- Population statistics within/outside isochrones
- Demographic analysis by race/ethnicity
- Temporal trends in accessibility (2013-2023)
- Visualizations of geographic access patterns

## Development Notes

### TODO Items
1. Update `01-setup.R` with any changes to bespoke functions. Fix the `get_census_data` function.
2. Year-specific physicians are in `data/02.5-subspecialists_over_time/distinct_year_by_year_nppes_data_validated_npi.csv`.
3. Fix the error in `04-geocode.R` at this line: `merged_data_sp <- as(merged_data,"Spatial")`.
4. Fix error in `05-geocode-cleaning.R` sanity check section with `Error in leaflet::addLegend(., position ="bottomright", colors = district_colors, : 'colors' and 'labels' must be of the same length`.
5. Update `06-isochrones.R` to handle multiple dates (using `iso_datetime_yearly`).
6. In `07-isochrone-mapping.R`, determine how to use `subspecialists_lat_long` for year-specific physicians.
7. Ensure `08-get-block-group-overlap.R` works with the entire USA instead of just Colorado.
8. Update `08.5-prep-the-census-variables.R` to download racial demographic data for all years.

## Data Sources

For downloading NPPES files:
```bash
wget -P "/Volumes/Video Projects Muffly 1/nppes_historical_downloads" "https://download.cms.gov/nppes/NPPES_Data_Dissemination_April_2024.zip"
```

## License

[Specify your license here]

## Contact

Tyler Muffly, MD - [Add contact information if appropriate]